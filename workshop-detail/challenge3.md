# 3.テストシナリオやクライテリアやテストデータを作成してテストを実行する

## 目的

不足しているテストの実装を行いたいのですが、テストにおけるルールなどが存在しません。
テスト実装のヒント作成の為ドキュメントを充実させてテストを実行する必要がありそうです。  
* e2e Testにおいてはテストシナリオが必要そうです。  
    * e2e TestとIntegration Testはテスト時にTesContainersをデータソースとして使用しているようなのでシードデータを特定する必要がありそうです。  
* テスト全般では完了条件が不明確なのでそれを定義する必要がありそうです

## 手段

GitHub Copilotを使用して現在のアプリケーション構造などからシナリオやテストデータを作成していきます。 `develop-standard` には共通規約として各テストに関わる規約が記載されているようです。プロンプトなどを作成する際は参考にできるかもしれません。

ヒントになりそうなキーワード
* テストカバレッジ: Unitテストの完了条件として
* Cucumber（ふるまい駆動）: e2eテストはふるまい駆動型の構成になっているようです
* Playwright: e2eのテスト実行はPlaywrightを使用しているようです
* ページオブジェクトパターン: e2eテストの構造を壊れにくくするためPlaywrightはページオブジェクトパターンで構築されているようです

## Sample Prompt（Agent Mode）

### UnitTest

``` markdown
各サービスのUnitTestを作成してください。CIは未実装なので、CIコマンドは記載しなくてOKです。
テストの規約に関しては `develop-standard` を参照してください。
テスト生成後はテストを実行し、テストがクリアするまで修正を行ってください。
テストコードの作成を実施する際は実装コードの変更は行わないでください。
テストレポートはGit管理の対象外としたい為 `/temp` ディレクトリに生成してください。
```

### Integration Test

``` markdown
各サービスでDBを使用したIntegration Testを作成してください。CIは未実装なので、CIコマンドは記載しなくてOKです。
テストの規約に関しては `develop-standard` を参照してください。
テストの際は開発用のDBを汚染させないため、TestContainersを使用します。
テストDBのテーブル作成などは既存の `database` ディレクトリ内のSQLを流用してください。
テストで必要なTestContainersDBのSeedDataの構築も実施してください。
テスト生成後はテストを実行し、テストがクリアするまで修正を行ってください。
テストコードの作成を実施する際は実装コードの変更は行わないでください。
実装コード側を変更する必要が発生した場合は報告してください。
テストレポートはGit管理の対象外としたい為 `/temp` ディレクトリに生成してください。
```

### e2e Test

``` markdown
現在のアプリケーションの構造からe2eテストを実施するためのシナリオを作成します。
シナリオは `src/e2e/features` にCucumberのフォーマットで `xxx.feature` として保存されます。
テストの際は開発用のDBを汚染させないため、TestContainersを使用します。
テストで必要なTestContainersDBのSeedDataの構築も実施してください。
テストコードの作成を実施する際は実装コードの変更は行わないでください。
テストシナリオができあがったらまずはシナリオのレビューを実施します。
```

``` markdown
作成されたCucumberのシナリオに対して e2e テストを実装してください。
テストはPlaywrightで実行されます。テストコードは壊れにくい構成にするため、PageObjectモデルで構成されたオブジェクトを介して実行されます。
テストの構築ができたら e2eテストを実行してください。実行は下記の条件のもと行われます。
- テストレポートはGit管理の対象外としたい為 `/temp` ディレクトリに生成してください。
- テスト実施の様子を見たいので、成功している場合でも動画、スクリーンショットが残る形でテスト実行してください。
- テストコードの作成を実施する際は実装コードの変更は行わないでください
- TestContainerなど前準備が多いため、各サービスの準備ができたのちにテストを実施してください
- テストがすべて成功して終了した後は、レポート出力コマンドを実行してテスト内容を確認できるようにしてください。
```


**※e2eは壊れやすいテストの為沼る可能性が高いです(低スペックPCなどで実施した場合のネットワーク遅延など)**  
ネットワーク遅延が原因と思われる場合はテストをパスとみなすかFlakyテストとして扱ってほしい。みたいなPromptを追加したほうがいいかもしれません。
初回アクセスは失敗するけど継続アクセスは成功するみたいな動きをすることがあるようなので、その場合は初回アクセスは捨てるみたいな動作にしてもいいかもしれません。

## Advanced

現在のコードから単体～結合テストを構成するのも重要ですが、そもそも実装されていない機能を導き出すなどできる為、もとの要件からテストシナリオを作成したりするのも効果が高いです。余裕があればGitHub Copilotで必要な機能要件を類推した後テストシナリオを作成してもいいかもしれません(モダナイゼーションの文脈においては現在の振る舞いが変わらないことが最重要なのでAdvancedとして)

[次へ→](./challenge4.md)